<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gas Bill Calculator & Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>Gas Bill Calculator & Tracker</h1>

    <!-- Settings & Input -->
    <div class="card">
        <div class="grid grid-2">
            <div>
                <h2>Add Reading</h2>
                <div class="grid grid-2">
                    <div><label>Date</label><input type="datetime-local" id="inpDate"></div>
                    <div><label>Reading (m³)</label><input type="number" id="inpReading" step="0.001"></div>
                </div>
                <button onclick="app.addReading()" style="margin-top: 1rem;">Add Reading</button>
            </div>
            <div>
                <h2>Settings</h2>
                <div class="grid grid-2">
                    <div><label>Price/kWh (€)</label><input type="number" id="cfgPrice" step="0.000001"></div>
                    <div><label>Fixed/Day (€)</label><input type="number" id="cfgFixed" step="0.00001"></div>
                </div>
                <div class="grid grid-2" style="margin-top: 1rem;">
                    <div><label>Postcode (ES)</label><input type="text" id="cfgPostcode" placeholder="28001"></div>
                    <div style="display:flex; align-items:flex-end;"><button onclick="app.fetchWeather()">Fetch Weather</button></div>
                </div>
                <div class="grid grid-2" style="margin-top: 1rem;">
                    <button class="secondary" onclick="app.updateSettings()">Save Settings</button>
                    <button class="secondary" onclick="app.exportData()">Backup JSON</button>
                </div>
                <div class="grid grid-2" style="margin-top: 0.5rem;">
                    <button class="secondary" onclick="document.getElementById('fileInput').click()">Restore JSON</button>
                    <input type="file" id="fileInput" style="display:none" onchange="app.importData(this)">
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis -->
    <div class="card">
        <h2>Interval Analysis</h2>
        <p style="color: var(--text-muted); margin-bottom: 1rem;">Select two readings in the table below to analyze usage.</p>
        <div id="analysisPanel" class="grid grid-4 hidden">
            <div class="stat-box"><div><div class="stat-label">Days</div><div class="stat-value" id="outDays">-</div></div></div>
            <div class="stat-box"><div><div class="stat-label">Usage</div><div class="stat-value" id="outUsage">-</div></div></div>
            <div class="stat-box"><div><div class="stat-label">Cost</div><div class="stat-value" id="outCost">-</div></div></div>
            <div class="stat-box"><div><div class="stat-label">30-Day Proj.</div><div class="stat-value highlight-green" id="outProj">-</div></div></div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Readings Log</h2>
            <div>
                <button class="secondary" style="width:auto; padding:0.5rem 1rem;" onclick="app.resetData()">Reset</button>
            </div>
        </div>
        <div style="max-height: 400px; overflow: auto;">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Date</th>
                        <th>Reading</th>
                        <th>Diff</th>
                        <th>Cost</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Charts -->
    <div class="card">
        <h2>Readings Timeline</h2>
        <div class="chart-box"><canvas id="chartReadings"></canvas></div>
    </div>
    
    <div class="grid grid-2">
        <div class="card">
            <h2>Daily Usage & Cost</h2>
            <div class="chart-box"><canvas id="chartDaily"></canvas></div>
        </div>
        <div class="card">
            <h2>Cumulative Cost</h2>
            <div class="chart-box"><canvas id="chartCumulative"></canvas></div>
        </div>
    </div>

    <div class="grid grid-2">
        <div class="card">
            <h2>Projection Evolution</h2>
            <div class="chart-box"><canvas id="chartProjection"></canvas></div>
        </div>
        <div class="card">
            <h2>Cost Breakdown</h2>
            <div class="chart-box"><canvas id="chartBreakdown"></canvas></div>
        </div>
    </div>

    <div class="grid grid-2">
        <div class="card">
            <h2>Weather vs Usage</h2>
            <div class="chart-box"><canvas id="chartWeather"></canvas></div>
        </div>
        <div class="card">
            <h2>Efficiency Correlation</h2>
            <div class="chart-box"><canvas id="chartScatter"></canvas></div>
        </div>
    </div>

    <div class="card">
        <h2>Heating Efficiency (Usage per Degree-Day)</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">
            Shows gas used per degree of coldness (Base 15.5°C). Lower is better. Spikes indicate inefficiency.
        </p>
        <div class="chart-box"><canvas id="chartEfficiency"></canvas></div>
    </div>

    <script src="app.js"></script>
</body>
</html>
